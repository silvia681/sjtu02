<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Feigu | SJTU</title>
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.11/css/dataTables.bootstrap.min.css">

<!--<link rel="stylesheet" href="css/purple.css">-->

</head>

<body>

<div class="spinner">
  <div class="rect1"></div>
  <div class="rect2"></div>
  <div class="rect3"></div>
  <div class="rect4"></div>
  <div class="rect5"></div>
</div>

<div id="wrapper">
  <div class="overlay"></div>
  
  <!-- Sidebar -->
  <nav class="navbar navbar-inverse navbar-fixed-top" id="sidebar-wrapper" role="navigation">
    <ul class="nav sidebar-nav">
      <li class="sidebar-brand"> <a href="#"> 条件筛选 </a> </li>
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span data-toggle="tooltip" data-placement="right" title="选择汽车品牌"><i class="fa fa-fw fa-car"></i> <span id="brand_span">品牌</span> <span class="caret"></span></span></a>
        <ul class="dropdown-menu" role="menu">
          <li class="dropdown-header">品牌选择</li>
          <li><a href="#" id="brand-不限品牌">不限</a></li>
          <li><a href="#" id="brand-奥迪">奥迪</a></li>
          <li><a href="#" id="brand-大众">大众</a></li>
          <li><a href="#" id="brand-宝马">宝马</a></li>
          <li><a href="#" id="brand-奔驰">奔驰</a></li>
          <li><a href="#" id="brand-本田">本田</a></li>
          <li><a href="#" id="brand-福特">福特</a></li>
          <li><a href="#" id="brand-丰田">丰田</a></li>
        </ul>
      </li>
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span data-toggle="tooltip" data-placement="right" title="选择购车城市"><i class="fa fa-fw fa-home"></i> <span id="city_span">地区</span> <span class="caret"></span></span></a>
        <ul class="dropdown-menu" role="menu">
          <li class="dropdown-header">地区选择</li>
          <li><a href="#" id="city-全国">全国</a></li>
          <li><a href="#" id="city-上海">上海</a></li>
          <li><a href="#" id="city-北京">北京</a></li>
          <li><a href="#" id="city-重庆">重庆</a></li>
          <li><a href="#" id="city-成都">成都</a></li>
          <li><a href="#" id="city-南京">南京</a></li>
          <li><a href="#" id="city-青岛">青岛</a></li>
        </ul>

      </li>
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span data-toggle="tooltip" data-placement="right" title="选择价格区间"><i class="fa fa-fw fa-jpy"></i> <span id="price_span">价格</span> <span class="caret"></span></span></a>
        <ul class="dropdown-menu" role="menu">
          <li class="dropdown-header">价格选择</li>
          <li><a href="#" id="price-不限价格-free">不限</a></li>
          <li><a href="#" id="price-0-5">5万以下</a></li>
          <li><a href="#" id="price-5-15">5-15万</a></li>
          <li><a href="#" id="price-15-30">15-30万</a></li>
          <li><a href="#" id="price-30-60">30-60万</a></li>
          <li><a href="#" id="price-60-1000000000">60万以上</a></li>
        </ul>

      </li>
     <!-- <li> <a href="#"><i class="fa fa-fw fa-search"></i> 搜索</a></li>-->
      <li> <a href="#" id="refresh"><span id="refresh" data-toggle="tooltip" data-placement="right" title="同步后台实时数据"><i class="fa fa-fw fa-refresh"></i> 同步</a></span></li>
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span data-toggle="tooltip" data-placement="right" title="选择系统主题"><i class="fa fa-fw fa-exchange"></i> <span id="theme_span">主题</span> <span class="caret"></span></span></a>
        <ul class="dropdown-menu" role="menu">
          <li class="dropdown-header">主题切换</li>
          <li><a href="#" id="theme-purple-1-2">紫色系</a></li>
          <li><a href="#" id="theme-black-1-2">黑色系</a></li>
          <li><a href="#" id="theme-white-1-2">米色系</a></li>
          <li><a href="#" id="theme-blue-1-2">蓝色系</a></li>
        </ul>
    </ul>
	</li>
  </nav>
  <!-- /#sidebar-wrapper --> 
  
  <!-- Page Content -->
  <div id="page-content-wrapper">
    <button type="button" class="hamburger is-closed animated fadeInLeft" data-toggle="offcanvas"> <span class="hamb-top"></span> <span class="hamb-middle"></span> <span class="hamb-bottom"></span> </button>
    <div class="container">
      <div class="row">
        <!--
		<div class="col-lg-5 col-lg-offset-2">
          <h1 class="page-header">二手车比价系统  by T2.SJTU</h1>
        </div>
		-->
        <table id="data-table" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead class='table-color'>
            <tr>
                <th>车型</th>
                <th>购买地区</th>
                <th>购车日期</th>
                <th>发表日期</th>
                <th>新车价</th>
                <th>售价</th>
                <th>折旧率</th>
                <th>购买链接</th>
            </tr>
        </thead>
        <tfoot class='table-color'>
            <tr>
                <th>车型</th>
                <th>购买地区</th>
                <th>购车日期</th>
                <th>发表日期</th>
                <th>新车价</th>
                <th>售价</th>
                <th>折旧率</th>
                <th>购买链接</th>
            </tr>
        </tfoot>
        <tbody>
        </tbody>
      </table>
      </div>
    </div>
  </div>
  <!-- /#page-content-wrapper --> 
  <div style='position: fixed; bottom: 0px; width: 100%; text-align: center' class='table-font-color'>
	<p>&copy; 2016 SJTU Team2</p>
  </div>
</div>
<!-- /#wrapper --> 
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script> 
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script> 
<script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.11/js/dataTables.bootstrap.min.js"></script>
<script>

var cache;
var brand, city, price, minp, maxp;
var theme;
var tmap = new Array();

$(document).ready(function () {
	var trigger = $('.hamburger'), overlay = $('.overlay'), isClosed = false;

	trigger.click(function () {
		hamburger_cross();      
    });

    function hamburger_cross() {
		if (isClosed == true) {          
        	overlay.hide();
        	trigger.removeClass('is-open');
        	trigger.addClass('is-closed');
        	isClosed = false;
      	} else {   
        	overlay.show();
        	trigger.removeClass('is-closed');
        	trigger.addClass('is-open');
        	isClosed = true;
      	}
  	}
  
  	$('[data-toggle="offcanvas"]').click(function () {
		$('#wrapper').toggleClass('toggled');
  	});
 	
	$('[data-toggle="tooltip"]').tooltip();
  	$('.spinner').hide();
  	minp = 1;
  	maxp = 0;

  	$('a').click(function(e){
    	var id = e.target.id;
		if(id == 'refresh'){
			$('#data-table').DataTable().destroy();
			displayAll();
			return;
		}
    	var arr = id.split('-');
    	if(arr.length == 2){
    		if(arr[0] == 'brand'){
        		$("#brand_span").html("品牌（"+arr[1]+"）");
				if(arr[1] != '不限品牌'){
					filterColumn(0, arr[1]);
				}else{
					filterColumn(0, ".*");
				}
      		}else{
        		$("#city_span").html("地区（"+arr[1]+"）");
				if(arr[1] != '全国'){
					filterColumn(1, arr[1]);
				}else{
					filterColumn(1, ".*");
				}
      		}
    	}else if(arr.length == 3){
	  		minp = arr[1];
	  		maxp = arr[2];

      		if(arr[1] == "不限价格"){
				minp = 1;
				maxp = 0;
        		$("#price_span").html("价格（不限价格）");
      		}else if(arr[1] == 0){
        		$("#price_span").html("价格（小于5万）");
      		}else if(arr[1] == 60){
        		$("#price_span").html("价格（大于60万）");
      		}else{
        		$("#price_span").html("价格（"+arr[1]+"-"+arr[2]+"万）");
      		}
	  		if(arr[1] != '不限价格'){
				$('#data-table').DataTable().draw();
	  		}else{
	  			filterColumn(5, ".*");
	  		}
    	}else if(arr.length == 4 && arr[0] == 'theme'){
			if(arr[1] != theme){
				$(".spinner").show();
				$("#wrapper").hide();
				$("#theme-"+theme).remove();
				theme = arr[1];
				$("#theme_span").html("主题（"+ tmap[theme] +"）");
				$("<link>").attr({rel:"stylesheet", type:"text/css", href:"css/"+theme+".css", id:"theme-"+theme}).appendTo("head");
				$(".spinner").hide();
				$("#wrapper").show();
			}
		}
  	});


	theme = 'white';
	
	tmap['purple'] = '紫色系';
	tmap['black'] = '黑色系';
	tmap['white'] = '米色系';
	tmap['blue'] = '蓝色系';
	displayAll();
});

$.fn.dataTable.ext.search.push(
	function(settings, data, dataIndex){
			var p = data[5];
			p = parseFloat(p.substr(0, p.length-1));
			minp = parseFloat(minp);
			maxp = parseFloat(maxp);
			if(minp > maxp){
				return true;
			}
			if(p >= minp && p < maxp) return true;
			return false;
	}
);

function filterColumn(i, val){
	$('#data-table').DataTable().column(i).search(
		val,
		true
	).draw();
}

function filter(){
	var array = eval("("+cache+")");
	$("tbody").empty();
	for(var i = 0; i < array.length; i++){
		var obj = array[i];
		
		var deal_date = obj['rpt_price.deal_date'];
		var post_date = obj['rpt_price.post_date'];
		deal_date = deal_date.substr(0,4)+'/'+deal_date.substr(4,2)+'/'+deal_date.substr(6,2);
		post_date = post_date.substr(0,4)+'/'+post_date.substr(4,2)+'/'+post_date.substr(6,2);
		
		/*
		var cta = obj['rpt_price.prov_name'];
		var ctb = obj['rpt_price.city_name'];
		var ctc = cta + ctb;
		console.log(cta+cta.length+ctb+ctb.length+ctc+ctc.length);
		cta = $.trim(cta);
		ctb = $.trim(ctb);
		ctc = $.trim(ctc);
		console.log(cta+cta.length+ctb+ctb.length+ctc+ctc.length);
		*/

		$("tbody").append(
			"<tr class='row-color'>"
				+"<td>"+obj['rpt_price.brand_name']+" "+obj['rpt_price.serial']+" "+obj['rpt_price.yeartype']+" "+obj['rpt_price.volumn']+" "+obj['rpt_price.carstyle']+"</td>"
				+"<td>"+$.trim(obj['rpt_price.prov_name'])+" "+$.trim(obj['rpt_price.city_name'])+"</td>"
				+"<td>"+deal_date+"</td>"
				+"<td>"+post_date+"</td>"
				+"<td>"+obj['rpt_price.guide_price']/10000+"万</td>"
				+"<td>"+obj['rpt_price.total_price']/10000+"万</td>"
				+"<td>"+obj['rpt_price.year_discount']+"</td>"
				+"<td><a href='"+obj['rpt_price.url']+"' target='_blank' style='color:black'>车主之家</a></td>"
				+"</tr>"
		);
	}
	
	$('#data-table').DataTable({
			'language':{
				"search": "<span class='table-font-color'>搜索：<span>",
				"oPaginate":{
					"sFirst": "首页",
					"sPrevious": "上一页",
					"sNext": "下一页",
					"sLast": "末页"
				},
				"sZeroRecords": "没有匹配结果",
				"sProcessing": "处理中...",
				"sLengthMenu": "<span class='table-font-color'>显示 _MENU_ 项结果</span>",
				"sInfo": "<span class='table-font-color'>显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项</span>",
				"sInfoEmpty": "<span class='table-font-color'>显示第 0 至 0 项结果，共 0 项</span>",
				"sInfoFiltered": "<span class='table-font-color'>（由 _MAX_ 项结果过滤）</span>",
				"sInfoThousands": "<span class='table-font-color'>,</span>"
			}
	});
}

function displayAll(){
	/*
	$('#data-table').DataTable({
			'language':{
				"search": "<span style='color:white'>搜索：</span>",
				"oPaginate":{
					"sFirst": "首页",
					"sPrevious": "上一页",
					"sNext": "下一页",
					"sLast": "末页"
				},
				"sZeroRecords": "没有匹配结果",
				"sProcessing": "处理中...",
				"sLengthMenu": "显示_MENU_项结果",
				"sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
				"sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
				"sInfoFiltered": "（由 _MAX_ 项结果过滤）",
				"sInfoThousands": ","
			}
	});
	*/
	$('#theme_span').html('主题（'+tmap[theme]+'）');
	$("<link>").attr({rel:"stylesheet", type:"text/css", href:"css/"+theme+".css", id:"theme-"+theme}).appendTo("head");
	$.ajax({
			url:"FeiguHandler",
			beforeSend:loading,
			success: onsuccess
	});
}

function loading(){
	$('#wrapper').hide();
	$('.spinner').show();
}

function onsuccess(data, status){
	console.log(status);
	cache = data;
	filter();
	$('.spinner').hide();
	$('#wrapper').show();
}
</script>
</body>
</html>
